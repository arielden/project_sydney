import { Request, Response } from 'express';
import QuizSessionModel from '../models/QuizSession';
import QuestionModel from '../models/Question';
import QuestionAttemptModel from '../models/QuestionAttempt';
import { body, param, validationResult } from 'express-validator';

interface AuthenticatedRequest extends Request {
  user?: {
    id: string;
    email: string;
  };
}

export const quizController = {
  /**
   * Start a new quiz session
   * POST /api/quiz/start
   */
  async startQuiz(req: AuthenticatedRequest, res: Response) {
    try {
      // Validate request
      const errors = validationResult(req);
      if (!errors.isEmpty()) {
        return res.status(400).json({
          success: false,
          message: 'Validation errors',
          errors: errors.array()
        });
      }

      const { sessionType } = req.body;
      const userId = req.user?.id;

      if (!userId) {
        return res.status(401).json({
          success: false,
          message: 'User not authenticated'
        });
      }

      // Check for existing active sessions
      const activeSessions = await QuizSessionModel.getUserActiveSessions(userId);
      if (activeSessions.length > 0) {
        return res.status(400).json({
          success: false,
          message: 'You already have an active quiz session. Please complete or abandon it first.',
          activeSession: activeSessions[0]
        });
      }

      // Create new session
      const session = await QuizSessionModel.createSession({
        userId,
        sessionType
      });

      // Get initial questions based on session type
      let questions;
      const questionCount = sessionType === 'diagnostic' ? 44 : 20;

      if (sessionType === 'diagnostic') {
        questions = await QuestionModel.getDiagnosticQuestions(questionCount);
      } else if (sessionType === 'practice') {
        // Get user's current rating for adaptive selection
        questions = await QuestionModel.getPracticeQuestions(questionCount, 1200);
      } else {
        // Timed test - mixed questions
        questions = await QuestionModel.getRandomQuestions(questionCount);
      }

      if (questions.length === 0) {
        return res.status(500).json({
          success: false,
          message: 'No questions available for this quiz type'
        });
      }

      // Return first question
      const firstQuestion = questions[0];

      res.status(201).json({
        success: true,
        message: 'Quiz session started successfully',
        data: {
          session: {
            id: session.id,
            type: session.session_type,
            status: session.status,
            startTime: session.start_time
          },
          question: {
            id: firstQuestion.id,
            questionText: firstQuestion.question_text,
            options: firstQuestion.options,
            questionType: firstQuestion.question_type,
            questionNumber: 1,
            totalQuestions: questionCount
          },
          totalQuestions: questionCount
        }
      });

    } catch (error) {
      console.error('Error starting quiz:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to start quiz session'
      });
    }
  },

  /**
   * Get next question for a session
   * GET /api/quiz/:sessionId/next
   */
  async getNextQuestion(req: AuthenticatedRequest, res: Response) {
    try {
      const { sessionId } = req.params;
      const userId = req.user?.id;

      if (!sessionId) {
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      // Verify session belongs to user
      const session = await QuizSessionModel.getSession(sessionId);
      if (!session || session.user_id !== userId) {
        return res.status(404).json({
          success: false,
          message: 'Session not found'
        });
      }

      if (session.status !== 'active') {
        return res.status(400).json({
          success: false,
          message: 'Session is not active'
        });
      }

      // Get questions already attempted
      const attemptedQuestionIds = await QuestionAttemptModel.getAttemptedQuestionIds(sessionId);
      
      // Get session attempts to determine question number
      const attempts = await QuestionAttemptModel.getSessionAttempts(sessionId);
      const currentQuestionNumber = attempts.length + 1;

      // Determine total questions based on session type
      const totalQuestions = session.session_type === 'diagnostic' ? 44 : 20;

      if (currentQuestionNumber > totalQuestions) {
        return res.status(400).json({
          success: false,
          message: 'Quiz is already completed'
        });
      }

      // Get next question
      let nextQuestions;
      if (session.session_type === 'diagnostic') {
        nextQuestions = await QuestionModel.getDiagnosticQuestions(1);
      } else if (session.session_type === 'practice') {
        nextQuestions = await QuestionModel.getPracticeQuestions(1, 1200);
      } else {
        nextQuestions = await QuestionModel.getRandomQuestions(1, {
          excludeIds: attemptedQuestionIds
        });
      }

      // Filter out already attempted questions
      const availableQuestions = nextQuestions.filter(q => 
        !attemptedQuestionIds.includes(q.id)
      );

      if (availableQuestions.length === 0) {
        return res.status(400).json({
          success: false,
          message: 'No more questions available'
        });
      }

      const nextQuestion = availableQuestions[0];

      res.json({
        success: true,
        data: {
          question: {
            id: nextQuestion.id,
            questionText: nextQuestion.question_text,
            options: nextQuestion.options,
            questionType: nextQuestion.question_type,
            questionNumber: currentQuestionNumber,
            totalQuestions
          }
        }
      });

    } catch (error) {
      console.error('Error getting next question:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to get next question'
      });
    }
  },

  /**
   * Submit answer for a question
   * POST /api/quiz/:sessionId/answer
   */
  async submitAnswer(req: AuthenticatedRequest, res: Response) {
    try {
      const errors = validationResult(req);
      if (!errors.isEmpty()) {
        return res.status(400).json({
          success: false,
          message: 'Validation errors',
          errors: errors.array()
        });
      }

      const { sessionId } = req.params;
      const { questionId, userAnswer, timeSpent } = req.body;
      const userId = req.user?.id;

      if (!sessionId) {
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      // Verify session belongs to user
      const session = await QuizSessionModel.getSession(sessionId);
      if (!session || session.user_id !== userId) {
        return res.status(404).json({
          success: false,
          message: 'Session not found'
        });
      }

      if (session.status !== 'active') {
        return res.status(400).json({
          success: false,
          message: 'Session is not active'
        });
      }

      // Check if question was already attempted
      const alreadyAttempted = await QuestionAttemptModel.hasAttempted(sessionId, questionId);
      if (alreadyAttempted) {
        return res.status(400).json({
          success: false,
          message: 'Question already attempted'
        });
      }

      // Record the attempt
      const attempt = await QuestionAttemptModel.recordAttempt({
        sessionId,
        questionId,
        userId: userId!,
        userAnswer,
        timeSpent
      });

      res.json({
        success: true,
        message: 'Answer submitted successfully',
        data: {
          isCorrect: attempt.is_correct,
          questionId: attempt.question_id,
          userAnswer: attempt.user_answer
        }
      });

    } catch (error) {
      console.error('Error submitting answer:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to submit answer'
      });
    }
  },

  /**
   * Pause quiz session
   * POST /api/quiz/:sessionId/pause
   */
  async pauseQuiz(req: AuthenticatedRequest, res: Response) {
    try {
      const { sessionId } = req.params;
      const userId = req.user?.id;

      if (!sessionId) {
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      // Verify session belongs to user
      const session = await QuizSessionModel.getSession(sessionId);
      if (!session || session.user_id !== userId) {
        return res.status(404).json({
          success: false,
          message: 'Session not found'
        });
      }

      if (session.is_paused) {
        return res.status(400).json({
          success: false,
          message: 'Session is already paused'
        });
      }

      const pausedSession = await QuizSessionModel.pauseSession(sessionId);

      res.json({
        success: true,
        message: 'Quiz paused successfully',
        data: {
          session: {
            id: pausedSession.id,
            isPaused: pausedSession.is_paused,
            pauseTime: pausedSession.pause_time
          }
        }
      });

    } catch (error) {
      console.error('Error pausing quiz:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to pause quiz'
      });
    }
  },

  /**
   * Resume quiz session
   * POST /api/quiz/:sessionId/resume
   */
  async resumeQuiz(req: AuthenticatedRequest, res: Response) {
    try {
      const { sessionId } = req.params;
      const userId = req.user?.id;

      if (!sessionId) {
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      // Verify session belongs to user
      const session = await QuizSessionModel.getSession(sessionId);
      if (!session || session.user_id !== userId) {
        return res.status(404).json({
          success: false,
          message: 'Session not found'
        });
      }

      if (!session.is_paused) {
        return res.status(400).json({
          success: false,
          message: 'Session is not paused'
        });
      }

      const resumedSession = await QuizSessionModel.resumeSession(sessionId);

      res.json({
        success: true,
        message: 'Quiz resumed successfully',
        data: {
          session: {
            id: resumedSession.id,
            isPaused: resumedSession.is_paused,
            totalPauseDuration: resumedSession.total_pause_duration
          }
        }
      });

    } catch (error) {
      console.error('Error resuming quiz:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to resume quiz'
      });
    }
  },

  /**
   * Complete quiz session
   * POST /api/quiz/:sessionId/complete
   */
  async completeQuiz(req: AuthenticatedRequest, res: Response) {
    try {
      const { sessionId } = req.params;
      const userId = req.user?.id;

      if (!sessionId) {
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      // Verify session belongs to user
      const session = await QuizSessionModel.getSession(sessionId);
      if (!session || session.user_id !== userId) {
        return res.status(404).json({
          success: false,
          message: 'Session not found'
        });
      }

      if (session.status !== 'active') {
        return res.status(400).json({
          success: false,
          message: 'Session is not active'
        });
      }

      // Complete the session
      const completedSession = await QuizSessionModel.completeSession(sessionId);

      // Calculate final score
      const score = await QuestionAttemptModel.calculateScore(sessionId);

      res.json({
        success: true,
        message: 'Quiz completed successfully',
        data: {
          session: {
            id: completedSession.id,
            status: completedSession.status,
            endTime: completedSession.end_time,
            totalPauseDuration: completedSession.total_pause_duration
          },
          score
        }
      });

    } catch (error) {
      console.error('Error completing quiz:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to complete quiz'
      });
    }
  },

  /**
   * Get quiz results
   * GET /api/quiz/:sessionId/results
   */
  async getQuizResults(req: AuthenticatedRequest, res: Response) {
    try {
      const { sessionId } = req.params;
      const userId = req.user?.id;

      if (!sessionId) {
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      // Verify session belongs to user
      const session = await QuizSessionModel.getSession(sessionId);
      if (!session || session.user_id !== userId) {
        return res.status(404).json({
          success: false,
          message: 'Session not found'
        });
      }

      // Get detailed results
      const results = await QuestionAttemptModel.getSessionResults(sessionId);

      res.json({
        success: true,
        data: results
      });

    } catch (error) {
      console.error('Error getting quiz results:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to get quiz results'
      });
    }
  },

  /**
   * Get current session status
   * GET /api/quiz/:sessionId/status
   */
  async getSessionStatus(req: AuthenticatedRequest, res: Response) {
    try {
      const { sessionId } = req.params;
      const userId = req.user?.id;

      if (!sessionId) {
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      const session = await QuizSessionModel.getSession(sessionId);
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      const session = await QuizSessionModel.getSession(sessionId);
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      const session = await QuizSessionModel.getSession(sessionId);
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      const session = await QuizSessionModel.getSession(sessionId);
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      const session = await QuizSessionModel.getSession(sessionId);
        return res.status(400).json({
          success: false,
          message: 'Session ID is required'
        });
      }

      const session = await QuizSessionModel.getSession(sessionId);
      if (!session || session.user_id !== userId) {
        return res.status(404).json({
          success: false,
          message: 'Session not found'
        });
      }

      // Get current progress
      const attempts = await QuestionAttemptModel.getSessionAttempts(sessionId);
      const totalQuestions = session.session_type === 'diagnostic' ? 44 : 20;
      const elapsedTime = await QuizSessionModel.getSessionElapsedTime(sessionId);

      res.json({
        success: true,
        data: {
          session: {
            id: session.id,
            type: session.session_type,
            status: session.status,
            isPaused: session.is_paused,
            startTime: session.start_time,
            endTime: session.end_time,
            totalPauseDuration: session.total_pause_duration
          },
          progress: {
            currentQuestion: attempts.length + 1,
            totalQuestions,
            answeredQuestions: attempts.length,
            elapsedTime
          }
        }
      });

    } catch (error) {
      console.error('Error getting session status:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to get session status'
      });
    }
  }
};

// Validation middleware
export const startQuizValidation = [
  body('sessionType')
    .isIn(['practice', 'diagnostic', 'timed'])
    .withMessage('Session type must be practice, diagnostic, or timed')
];

export const submitAnswerValidation = [
  param('sessionId').isUUID().withMessage('Invalid session ID'),
  body('questionId').isUUID().withMessage('Invalid question ID'),
  body('userAnswer').notEmpty().withMessage('Answer is required'),
  body('timeSpent').isInt({ min: 0 }).withMessage('Time spent must be a positive integer')
];

export const sessionParamValidation = [
  param('sessionId').isUUID().withMessage('Invalid session ID')
];